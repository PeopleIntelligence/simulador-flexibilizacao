<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Descontos de Flexibiliza√ß√£o</title>

  <!-- MSAL.js v2 (Authorization Code + PKCE) -->
  https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js</script>

  <!-- Classe utilit√°ria para esconder/mostrar trechos sem alterar seu layout -->
  <style>.hidden{display:none!important}</style>
</head>
<body>

  <!-- ====== CONTE√öDO ORIGINAL (mantido) ====== -->

  <h1>Simulador de Descontos de Flexibiliza√ß√£o</h1>

  <h2>üîê Simulador</h2>

  <!-- Bloco de login / instru√ß√µes -->
  <section id="area-login">
    <p>Simulador de Descontos de Flexibiliza√ß√£o</p>
    <p>Acesso Restrito - Gestores e L√≠deres</p>

    <p>üè¢ Autentica√ß√£o Corporativa<br>
    Use suas credenciais Microsoft da empresa para acessar o simulador. </p>

    <!-- Bot√£o ‚ÄúEntrar com Microsoft‚Äù (mantido) -->
    <button id="btnLogin" type="button">Entrar com Microsoft</button>
  </section>

  <!-- Cabe√ßalho ‚ÄúUsu√°rio Autenticado‚Äù (mantido) -->
  <h5>##### Usu√°rio Autenticado</h5>
  <p id="usuarioEmail">usuario@empresa.com</p>

  <!-- Simulador (fica oculto at√© autenticar para manter o acesso restrito) -->
  <section id="simulador" class="hidden">
    <h2>üìä Simulador</h2>

    <p>
      Simulador de Descontos de Flexibiliza√ß√£o <br>
      ‚ö†Ô∏è Aten√ß√£o: Os valores calculados s√£o estimativas e t√™m apenas car√°ter orientativo.
      Os valores definitivos ser√£o informados na folha de pagamento.
      A empresa remunera 50% das horas n√£o trabalhadas. <br>
      üóíÔ∏è Jornada considerada: Esta simula√ß√£o considera uma jornada de trabalho de <strong>8,8 horas por dia</strong>.
    </p>

    <div>
      <label for="salario">Sal√°rio bruto mensal (R$)</label><br>
      <input id="salario" type="number" step="0.01" placeholder="Ex.: 5000,00" />
    </div>
    <br>
    <div>
      <label for="dias">Quantidade de dias de flexibiliza√ß√£o</label><br>
      <input id="dias" type="number" step="1" placeholder="Ex.: 3" />
    </div>
    <br>
    <button id="btnCalcular" type="button">Calcular Simula√ß√£o</button>

    <h4>üìà Resultado da Simula√ß√£o</h4>
    <p><strong>Custo para empresa (com encargos)</strong> ‚Äî <span id="outCustoEmpresa">‚Äî</span></p>
    <p><strong>Desconto do funcion√°rio</strong> ‚Äî <span id="outDescontoFunc">‚Äî</span></p>
    <p><strong>Percentual do sal√°rio</strong> ‚Äî <span id="outPercSalario">‚Äî</span></p>
    <p><strong>Sal√°rio estimado*</strong> ‚Äî <span id="outSalarioEstimado">‚Äî</span></p>
    <p>
      * Importante: O "Sal√°rio estimado" n√£o considera encargos, descontos de benef√≠cios, horas extras e outros fatores.
      Por isso √© apenas um valor estimado para orienta√ß√£o.
    </p>

    <h4>üìë M√©todo de c√°lculo:</h4>
    <ul>
      <li>Valor hora = Sal√°rio bruto √∑ 220 horas</li>
      <li>Valor dia = Valor hora √ó 8,8 horas (jornada normal)</li>
      <li>Desconto funcion√°rio = (Valor dia √ó Dias flexibilizados) √∑ 2</li>
      <li>Custo empresa = ((Sal√°rio √∑ 220) √ó 1,36 √ó 8,8 √ó 0,5) √ó Dias flexibilizados</li>
    </ul>

    <!-- Sair (mantido) -->
    <p><button id="btnLogout" type="button">Sair</button></p>
  </section>

  <!-- Mensagens de erro amig√°veis (n√£o interfere no layout) -->
  <div id="msg" class="hidden" role="alert" aria-live="polite"></div>

  <!-- ====== FIM DO CONTE√öDO ORIGINAL ====== -->

  <!-- ====== SCRIPT DE AUTENTICA√á√ÉO + L√ìGICA DO SIMULADOR ====== -->
  <script>
    (function () {
      // Utilidades simples para manter seu layout intacto
      const $ = (id) => document.getElementById(id);
      const show = (el) => el && el.classList.remove('hidden');
      const hide = (el) => el && el.classList.add('hidden');
      const setText = (el, t) => el && (el.textContent = t);

      // Elementos j√° existentes
      const els = {
        areaLogin: $('area-login'),
        areaApp:   $('simulador'),
        btnLogin:  $('btnLogin'),
        btnLogout: $('btnLogout'),
        usuarioEmail: $('usuarioEmail'),
        msg: $('msg'),
        // Simulador
        salario: $('salario'),
        dias: $('dias'),
        btnCalcular: $('btnCalcular'),
        outCustoEmpresa: $('outCustoEmpresa'),
        outDescontoFunc: $('outDescontoFunc'),
        outPercSalario: $('outPercSalario'),
        outSalarioEstimado: $('outSalarioEstimado')
      };

      function showError(message) {
        if (!els.msg) return;
        els.msg.classList.remove('hidden');
        els.msg.style.color = '#9b1c1c';
        els.msg.style.background = '#fff5f5';
        els.msg.style.border = '1px solid #ffcccc';
        els.msg.style.padding = '12px';
        els.msg.style.margin = '12px 0';
        els.msg.textContent = message;
        console.error('[AUTH]', message);
      }

      // Configura√ß√£o do App (Single-tenant)
      const msalConfig = {
        auth: {
          clientId: "0c2709b6-cbe4-4e55-9967-f9619abddc54",
          authority: "https://login.microsoftonline.com/812a6bd0-5829-4196-b2be-d0580b7bd0cb",
          redirectUri: "https://peopleintelligence.github.io/simulador-flexibilizacao/"
        },
        cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false },
        system: {
          allowRedirectInIframe: true,
          loggerOptions: {
            loggerCallback: (l, m) => console.debug("[MSAL]", m),
            logLevel: (window.msal && msal.LogLevel && msal.LogLevel.Warning) || 2,
            piiLoggingEnabled: false
          }
        }
      };

      // Inicia quando a p√°gina est√° pronta
      window.addEventListener('load', async () => {
        // Garante que o MSAL carregou ‚Äî evita "msal is not defined"
        if (!window.msal || !msal.PublicClientApplication) {
          showError('MSAL n√£o carregou. Confirme a tag ...msal-browser.min.js</script> no <head>.');
          return;
        }

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const loginRequest = { scopes: ["openid", "profile", "email"] };

        function applyAuthenticatedUI(account) {
          if (account) {
            setText(els.usuarioEmail, account.username || account.name || account.homeAccountId || 'Usu√°rio');
            hide(els.areaLogin);
            show(els.areaApp);
          } else {
            show(els.areaLogin);
            hide(els.areaApp);
          }
        }

        try {
          // Trata o retorno do redirect (login/logout)
          const response = await msalInstance.handleRedirectPromise();
          if (response && response.account) msalInstance.setActiveAccount(response.account);

          // Ajusta UI conforme sess√£o atual
          const account = msalInstance.getActiveAccount() || (msalInstance.getAllAccounts && msalInstance.getAllAccounts()[0]) || null;
          applyAuthenticatedUI(account);

          // Entrar com Microsoft (impede qualquer fluxo "antigo" implicit)
          if (els.btnLogin) {
            els.btnLogin.addEventListener('click', (ev) => {
              try { ev.preventDefault(); } catch(_) {}
              msalInstance.loginRedirect(loginRequest);
            });
          }

          // Sair
          if (els.btnLogout) {
            els.btnLogout.addEventListener('click', (ev) => {
              try { ev.preventDefault(); } catch(_) {}
              msalInstance.logoutRedirect({ postLogoutRedirectUri: msalConfig.auth.redirectUri });
            });
          }

          // L√≥gica do simulador (mantida conforme m√©todo informado no seu conte√∫do)
          if (els.btnCalcular) {
            els.btnCalcular.addEventListener('click', () => {
              const salario = parseFloat(String(els.salario && els.salario.value || '').replace(',', '.')) || 0;
              const dias = parseInt(els.dias && els.dias.value, 10) || 0;

              // ‚Ä¢ Valor hora = Sal√°rio bruto √∑ 220 horas
              // ‚Ä¢ Valor dia = Valor hora √ó 8,8 horas (jornada normal)
              // ‚Ä¢ Desconto funcion√°rio = (Valor dia √ó Dias flexibilizados) √∑ 2
              // ‚Ä¢ Custo empresa = ((Sal√°rio √∑ 220) √ó 1,36 √ó 8,8 √ó 0,5) √ó Dias flexibilizados
              const valorHora = salario / 220;
              const valorDia = valorHora * 8.8;
              const descontoFuncionario = (valorDia * dias) / 2;
              const custoEmpresa = ((salario / 220) * 1.36 * 8.8 * 0.5) * dias;
              const salarioEstimado = Math.max(salario - descontoFuncionario, 0);
              const percSalario = salario ? (descontoFuncionario / salario) * 100 : 0;

              const brl = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

              if (els.outCustoEmpresa)    els.outCustoEmpresa.textContent = brl(custoEmpresa);
              if (els.outDescontoFunc)    els.outDescontoFunc.textContent = brl(descontoFuncionario);
              if (els.outPercSalario)     els.outPercSalario.textContent = percSalario.toFixed(2) + '%';
              if (els.outSalarioEstimado) els.outSalarioEstimado.textContent = brl(salarioEstimado);
            });
          }
        } catch (e) {
          console.error(e);
          let msg = String(e && (e.errorMessage || e.message || e));
          const m = msg.toLowerCase();

          if (m.includes('aadsts50105')) {
            msg = 'Acesso n√£o autorizado: seu usu√°rio n√£o est√° atribu√≠do a este aplicativo. Solicite acesso √† TI (gestores/l√≠deres).';
          } else if (m.includes('no reply address provided') || m.includes('redirect_uri')) {
            msg = 'Redirect URI inv√°lida no Entra ID. Verifique a URL exata em App registrations > Authentication.';
          } else if (m.includes('aadsts700051') || m.includes('unsupported_response_type')) {
            msg = 'Fluxo de login antigo (implicit) detectado. Atualize a p√°gina (Ctrl/Cmd+F5). Se persistir, remova scripts antigos (ADAL/MSAL v1).';
          }

          showError(msg);
          // Mant√©m tela de login vis√≠vel em caso de falha
          show(els.areaLogin);
        }
      });
    })();
  </script>
</body>
</html>
