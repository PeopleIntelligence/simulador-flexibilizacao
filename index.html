<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Simulador de Descontos de Flexibilização</title>
  https://alcdn.msauth.net/browser/2.45.0/js/msal-browser.min.js</script>
</head>
<body>
  <h1>Simulador de Descontos de Flexibilização</h1>
  <div id="auth-section">
    <button id="btn-login">Entrar com Microsoft</button>
    <button id="btn-logout" style="display:none;">Sair</button>
    <div id="auth-info" style="display:none;"></div>
    <div id="auth-warning" style="display:none; color:red;"></div>
  </div>

  <div id="app-section" style="display:none;">
    <h2>Cálculo de Descontos de Flexibilização</h2>
    <label for="salario">Salário bruto mensal (R$)</label>
    <input id="salario" type="number" step="0.01" min="0" />
    <label for="dias">Quantidade de dias de flexibilização (0 a 30)</label>
    <input id="dias" type="number" step="1" min="0" max="30" />
    <button id="btn-calc">Calcular</button>
    <div id="val-msg" style="color:red; display:none;"></div>
    <div id="kpi-custo-empresa">Custo para empresa: —</div>
    <div id="kpi-desc-func">Desconto do funcionário: —</div>
    <div id="kpi-perc-sal">Percentual do salário: —</div>
    <div id="kpi-sal-est">Salário estimado: —</div>
  </div>

  <script>
    const MSAL_CONFIG = {
      auth: {
        clientId: "0c2709b6-cbe4-4e55-9967-f9619abddc54",
        authority: "https://login.microsoftonline.com/812a6bd0-5829-4196-b2be-d0580b7bd0cb",
        redirectUri: "https://peopleintelligence.github.io/simulador-flexibilizacao/"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: true
      }
    };

    const ALLOWED_DOMAINS = ["randoncorp.com", "randon.com.br"];

    const msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);

    const btnLogin = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    const authInfo = document.getElementById("auth-info");
    const authWarning = document.getElementById("auth-warning");
    const appSection = document.getElementById("app-section");
    const authSection = document.getElementById("auth-section");

    const salarioEl = document.getElementById("salario");
    const diasEl = document.getElementById("dias");
    const btnCalc = document.getElementById("btn-calc");
    const valMsg = document.getElementById("val-msg");
    const kpiCustoEmpresa = document.getElementById("kpi-custo-empresa");
    const kpiDescFunc = document.getElementById("kpi-desc-func");
    const kpiPercSal = document.getElementById("kpi-perc-sal");
    const kpiSalEst = document.getElementById("kpi-sal-est");

    function moedaBRL(v) {
      return isFinite(v) ? v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" }) : "—";
    }

    function pct(v) {
      return isFinite(v) ? v.toLocaleString("pt-BR", { maximumFractionDigits: 2 }) + "%" : "—";
    }

    function validar() {
      const salario = Number(salarioEl.value);
      const dias = Number(diasEl.value);
      let erros = [];
      if (!(salario > 0)) erros.push("Informe um salário válido.");
      if (!(Number.isInteger(dias) && dias >= 0 && dias <= 30)) erros.push("Dias devem estar entre 0 e 30.");
      if (erros.length) {
        valMsg.textContent = erros.join(" ");
        valMsg.style.display = "block";
        return null;
      }
      valMsg.style.display = "none";
      return { salario, dias };
    }

    function calcular() {
      const data = validar();
      if (!data) return;
      const { salario, dias } = data;
      const valorHora = salario / 220;
      const valorDia = valorHora * 8.8;
      const descontoFuncionario = (valorDia * dias) / 2;
      const custoEmpresa = valorHora * 1.36 * 8.8 * 0.5 * dias;
      const percSal = (descontoFuncionario / salario) * 100;
      const salarioEstimado = salario - descontoFuncionario;

      kpiCustoEmpresa.textContent = "Custo para empresa: " + moedaBRL(custoEmpresa);
      kpiDescFunc.textContent = "Desconto do funcionário: " + moedaBRL(descontoFuncionario);
      kpiPercSal.textContent = "Percentual do salário: " + pct(percSal);
      kpiSalEst.textContent = "Salário estimado: " + moedaBRL(salarioEstimado);
    }

    btnCalc.addEventListener("click", calcular);

    btnLogin.addEventListener("click", () => {
      msalInstance.loginRedirect({ scopes: ["User.Read"], prompt: "select_account" });
    });

    btnLogout.addEventListener("click", () => {
      const account = msalInstance.getAllAccounts()[0];
      msalInstance.logoutRedirect({ account });
    });

    msalInstance.handleRedirectPromise().then(response => {
      if (response && response.account) {
        msalInstance.setActiveAccount(response.account);
      }
      const account = msalInstance.getAllAccounts()[0];
      if (account) {
        const domain = (account.username || "").split("@")[1];
        if (ALLOWED_DOMAINS.includes(domain)) {
          authInfo.textContent = "Autenticado como " + account.username;
          authInfo.style.display = "block";
          btnLogin.style.display = "none";
          btnLogout.style.display = "inline";
          authWarning.style.display = "none";
          authSection.style.display = "none";
          appSection.style.display = "block";
        } else {
          authWarning.textContent = "Domínio não autorizado.";
          authWarning.style.display = "block";
        }
      }
    }).catch(err => {
      console.error(err);
      authWarning.textContent = "Erro na autenticação.";
      authWarning.style.display = "block";
    });
  </script>
</body>
</html>
