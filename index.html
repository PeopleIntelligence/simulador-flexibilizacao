<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Flexibiliza√ß√£o ‚Äî Acesso via Microsoft</title>
  <meta name="description" content="Simulador de Descontos de Flexibiliza√ß√£o com autentica√ß√£o Microsoft (MSAL.js) e valida√ß√£o de grupo de TI." />

  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%234f46e5'/%3E%3Cpath d='M28 74c20-4 28-26 36-26s16 22 36 26c-20 4-28 26-36 26S48 78 28 74z' fill='white'/%3E%3C/svg%digo-600 */
      --primary-600:#4338ca;
      --danger:#ef4444;       /* red-500 */
      --success:#22c55e;      /* green-500 */
      --border:#1f2937;       /* gray-800 */
      --focus:#f59e0b;        /* amber-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0b1224 0%,#0f172a 60%,#0b1224 100%);
      color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Segoe UI Emoji,Segoe UI Symbol,sans-serif;
    }
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 24px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand__logo{
      width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#22d3ee);
      display:inline-block;box-shadow:0 0 0 3px rgba(255,255,255,0.06) inset;
    }
    .brand__title{font-weight:700;letter-spacing:.2px}

    .card{
      background:radial-gradient(1200px 200px at 50% -120px,rgba(79,70,229,.20),transparent),
                 linear-gradient(180deg,rgba(255,255,255,.015),rgba(255,255,255,.005));
      border:1px solid var(--border);border-radius:16px;padding:20px 18px;margin-bottom:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .hidden{display:none !important}
    h1{font-size:1.4rem;margin:6px 0 12px}
    h2{font-size:1.1rem;margin:0 0 10px;color:#c7d2fe}
    p{color:var(--muted);line-height:1.55}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    button,.btn{
      cursor:pointer;background:var(--primary);color:white;border:0;border-radius:10px;
      padding:10px 14px;font-weight:600;transition:.2s box-shadow,.2s transform,.2s background;
      box-shadow:0 6px 18px rgba(79,70,229,.25);
    }
    button:hover{background:var(--primary-600);transform:translateY(-1px)}
    button.secondary{background:#334155}
    button.danger{background:var(--danger)}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid.cols-2{grid-template-columns:1fr 1fr}}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#0b1224;color:var(--text);outline:none;transition:.2s border,.2s box-shadow;
    }
    input:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(245,158,11,.25)}
    .helper{font-size:.9rem;color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#111827;border:1px solid #1f2937;border-radius:6px;padding:2px 6px}
    .result{display:grid;gap:10px;margin-top:6px}
    .result__row{
      display:flex;align-items:center;justify-content:space-between;background:#0b1224;
      border:1px dashed #1f2937;border-radius:10px;padding:12px 14px
    }
    .result__label{color:#cbd5e1}
    .result__value{font-weight:700}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid var(--border);font-size:.9rem}
    .warning{color:#fde68a}
    footer{margin:26px 0;color:var(--muted);font-size:.92rem}
    .denied{border-color:rgba(239,68,68,.35);background:linear-gradient(180deg,rgba(239,68,68,.08),transparent)}
    .ok{border-color:rgba(34,197,94,.35);background:linear-gradient(180deg,rgba(34,197,94,.08),transparent)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <span class="brand__logo" aria-hidden="true"></span>
        <div>
          <div class="brand__title">Simulador de Flexibiliza√ß√£o</div>
          <div class="helper">Acesso protegido por Microsoft Entra ID (Azure AD)</div>
        </div>
      </div>
      <div class="helper" id="user-pill" aria-live="polite"></div>
    </header>

    <!-- 1) Autentica√ß√£o e checagem de grupo -->
    <section id="auth-section" class="card">
      <h1>Entrar com conta Microsoft</h1>
      <p>Para usar o simulador, autentique-se com sua conta corporativa. Em seguida, validaremos seu v√≠nculo ao <strong>grupo permitido pela TI</strong>.</p>
      <div class="actions">
        <button id="btn-login">Entrar com Microsoft</button>
        <button id="btn-try-again" class="secondary hidden">Tentar novamente</button>
      </div>
      <p class="helper">Dica: no GitHub Pages, configure a <span class="kbd">redirectUri</span> exatamente igual √† URL p√∫blica da p√°gina.</p>
      <div id="auth-status" class="helper" style="margin-top:10px"></div>
    </section>

    <!-- Acesso negado -->
    <section id="denied-section" class="card denied hidden" role="alert">
      <h1>‚õî Acesso negado</h1>
      <p>Seu usu√°rio est√° autenticado, por√©m <strong>n√£o pertence ao grupo permitido pela TI</strong>. Se voc√™ acredita que isso √© um engano, solicite acesso √† equipe de TI e tente novamente ap√≥s o provisionamento.</p>
      <div class="actions">
        <button id="btn-logout-denied" class="danger">Sair</button>
      </div>
    </section>

    <!-- 2) Simulador (liberado somente ap√≥s valida√ß√£o do grupo) -->
    <section id="app-section" class="card ok hidden">
      <h1>üßÆ Simulador de Descontos de Flexibiliza√ß√£o</h1>
      <div class="grid cols-2">
        <div>
          <label for="salario">Sal√°rio bruto mensal (R$)</label>
          <input id="salario" name="salario" inputmode="decimal" placeholder="Ex.: 5.000,00" aria-describedby="salarioHelp" />
          <div id="salarioHelp" class="helper">Use v√≠rgula para centavos. Ex.: <span class="kbd">3.250,50</span></div>
        </div>
        <div>
          <label for="dias">Quantidade de dias de flexibiliza√ß√£o</label>
          <input id="dias" name="dias" type="number" min="1" max="5" step="1" value="1" aria-describedby="diasHelp" />
          <div id="diasHelp" class="helper">Valor permitido: de 1 a 5 dias.</div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="btn-calcular">Calcular</button>
        <button id="btn-limpar" class="secondary">Limpar</button>
        <span class="badge" title="Jornada considerada">üóíÔ∏è Jornada: <strong>8,8 h/dia</strong></span>
      </div>

      <h2 style="margin-top:18px">üìà Resultado</h2>
      <div id="resultado" class="result hidden" aria-live="polite">
        <div class="result__row">
          <span class="result__label">Custo para empresa (com encargos)</span>
          <span id="out-custo-empresa" class="result__value mono">‚Äî</span>
        </div>
        <div class="result__row">
          <span class="result__label">Desconto do funcion√°rio</span>
          <span id="out-desconto-func" class="result__value mono">‚Äî</span>
        </div>
        <div class="result__row">
          <span class="result__label">Percentual do sal√°rio</span>
          <span id="out-percentual" class="result__value mono">‚Äî</span>
        </div>
        <div class="result__row">
          <span class="result__label">Sal√°rio estimado*</span>
          <span id="out-salario-estimado" class="result__value mono">‚Äî</span>
        </div>
      </div>

      <p class="helper warning" style="margin-top:10px">
        ‚ö†Ô∏è Os valores calculados s√£o estimativas e t√™m apenas car√°ter orientativo. Os valores definitivos ser√£o informados na folha de pagamento.
      </p>

      <details style="margin-top:6px">
        <summary class="helper">üìò M√©todo de c√°lculo (clique para ver)</summary>
        <ul class="helper" style="margin-top:8px">
          <li>Valor hora = Sal√°rio bruto √∑ 220 horas</li>
          <li>Valor dia = Valor hora √ó 8,8 horas (jornada normal)</li>
          <li>Desconto funcion√°rio = (Valor dia √ó Dias flexibilizados) √∑ 2</li>
          <li>Custo empresa = ((Sal√°rio √∑ 220) √ó 1,36 √ó 8,8 √ó 0,5) √ó Dias flexibilizados</li>
        </ul>
      </details>

      <div class="actions" style="margin-top:14px">
        <button id="btn-logout" class="danger">Sair</button>
      </div>
    </section>

    <footer>
      <div>‚Ä¢ Privacidade: nenhuma informa√ß√£o do simulador √© enviada a servidores da aplica√ß√£o. O token de acesso √© obtido via MSAL para consulta de grupos no Microsoft Graph.</div>
      <div>‚Ä¢ Suporte: se o acesso for negado, solicite inclus√£o no grupo permitido pela TI e tente novamente.</div>
    </footer>
  </div>

  <!-- IMPORT CORRETO DO MSAL (deve vir ANTES do seu script) -->
  https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js</script>

  <script>
    'use strict';

    // =========================
    // CONFIGURA√á√ÉO ‚Äî J√Å AJUSTADA
    // =========================
    const CONFIG = {
      msal: {
        auth: {
          clientId: "0c2709b6-cbe4-4e55-9967-f9619abddc54",
          authority: "https://login.microsoftonline.com/812a6bd0-5829-4196-b2be-d0580b7bd0cb",
          redirectUri: "https://peopleintelligence.github.io/simulador-flexibilizacao/",
          postLogoutRedirectUri: "https://peopleintelligence.github.io/simulador-flexibilizacao/"
        },
        cache: {
          cacheLocation: "localStorage",
          storeAuthStateInCookie: false
        }
      },
      graph: {
        scopes: ["User.Read", "GroupMember.Read.All"] // precisa de consentimento do admin
      },
      allowedGroups: {
        ids: [],                      // quando tiver, coloque o ID exato aqui: ["ID_DO_GRUPO_TI"]
        names: ["TI", "Tecnologia"]   // valida√ß√£o por nome (menos robusta)
      }
    };

    // =========================
    // GUARD: MSAL carregado?
    // =========================
    if (!window.msal || !window.msal.PublicClientApplication) {
      const msg = "Biblioteca MSAL n√£o foi carregada. Verifique a tag ...msal-browser.min.js</script> e a pol√≠tica de conte√∫do.";
      console.error(msg);
      alert("Erro ao carregar depend√™ncias (MSAL). Atualize a p√°gina (Ctrl+F5). Se persistir, entre em contato com a TI.");
      throw new Error(msg);
    }

    // =========================
    // ESTADO DA APLICA√á√ÉO
    // =========================
    const msalInstance = new msal.PublicClientApplication(CONFIG.msal);
    let account = null;
    let accessToken = null;

    // =========================
    // ELEMENTOS DE UI
    // =========================
    const $ = (sel) => document.querySelector(sel);
    const authSection = $("#auth-section");
    const deniedSection = $("#denied-section");
    const appSection = $("#app-section");
    const userPill = $("#user-pill");
    const authStatus = $("#auth-status");
    const btnLogin = $("#btn-login");
    const btnTryAgain = $("#btn-try-again");
    const btnLogout = $("#btn-logout");
    const btnLogoutDenied = $("#btn-logout-denied");

    // Simulador
    const salarioInput = $("#salario");
    the diasInput = $("#dias");
    const btnCalcular = $("#btn-calcular");
    const btnLimpar = $("#btn-limpar");
    const resultadoBox = $("#resultado");
    const outCustoEmpresa = $("#out-custo-empresa");
    const outDescontoFunc = $("#out-desconto-func");
    const outPercentual = $("#out-percentual");
    const outSalarioEstimado = $("#out-salario-estimado");

    // =========================
    // INICIALIZA√á√ÉO
    // =========================
    (async function init() {
      try {
        const resp = await msalInstance.handleRedirectPromise();
        if (resp && resp.account) {
          account = resp.account;
        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length) account = accounts[0];
        }
        if (account) {
          updateUserPill(account);
          await ensureAccess();
        } else {
          showOnly(authSection);
        }
      } catch (err) {
        console.warn("Redirect error:", err);
        showOnly(authSection);
      }
    })();

    // =========================
    // AUTENTICA√á√ÉO
    // =========================
    btnLogin.addEventListener("click", async () => {
      authStatus.textContent = "Abrindo janela de login...";
      try {
        const loginResp = await msalInstance.loginPopup({
          scopes: CONFIG.graph.scopes,
          prompt: "select_account"
        });
        account = loginResp.account;
        updateUserPill(account);
        await ensureAccess();
      } catch (e) {
        console.error(e);
        authStatus.textContent = "Falha no login. Tente novamente.";
        btnTryAgain.classList.remove("hidden");
      }
    });

    btnTryAgain.addEventListener("click", () => {
      btnTryAgain.classList.add("hidden");
      authStatus.textContent = "";
    });

    btnLogout?.addEventListener("click", () => logout());
    btnLogoutDenied?.addEventListener("click", () => logout());

    async function ensureAccess() {
      authStatus.textContent = "Validando v√≠nculo ao grupo permitido...";
      try {
        accessToken = await getToken();
        const isAllowed = await isUserInAllowedGroup(accessToken);
        if (isAllowed) {
          showOnly(appSection);
          authStatus.textContent = "";
        } else {
          showOnly(deniedSection);
          authStatus.textContent = "";
        }
      } catch (e) {
        console.error("Erro ao validar acesso:", e);
        authStatus.textContent = "N√£o foi poss√≠vel validar o grupo. Verifique as permiss√µes do aplicativo no Entra ID.";
        showOnly(authSection);
        btnTryAgain.classList.remove("hidden");
      }
    }

    async function getToken() {
      try {
        const silent = await msalInstance.acquireTokenSilent({
          account,
          scopes: CONFIG.graph.scopes
        });
        return silent.accessToken;
      } catch (_) {
        const interactive = await msalInstance.acquireTokenPopup({
          scopes: CONFIG.graph.scopes,
          prompt: "consent"
        });
        return interactive.accessToken;
      }
    }

    async function isUserInAllowedGroup(token) {
      const resp = await fetch("https://graph.microsoft.com/v1.0/me/memberOf?$select=id,displayName", {
        headers: { "Authorization": "Bearer " + token }
      });
      if (!resp.ok) {
        const text = await resp.text().catch(()=> "");
        throw new Error("Graph /me/memberOf falhou: " + resp.status + " ‚Äî " + text);
      }
      const data = await resp.json();
      const groups = data.value || [];

      const allowById = CONFIG.allowedGroups.ids.length > 0 && CONFIG.allowedGroups.ids.some(id =>
        groups.some(g => (g.id || "").toLowerCase() === id.toLowerCase())
      );

      const allowByName = CONFIG.allowedGroups.names.length > 0 && CONFIG.allowedGroups.names.some(name =>
        groups.some(g => (g.displayName || "").toLowerCase() === name.toLowerCase())
      );

      return allowById || allowByName;
    }

    function updateUserPill(acc) {
      userPill.innerHTML = acc
        ? `‚úÖ <strong>${acc.name || acc.username}</strong>`
        : "";
    }

    function showOnly(section) {
      [authSection, deniedSection, appSection].forEach(s => s.classList.add("hidden"));
      section.classList.remove("hidden");
    }

    function logout() {
      msalInstance.logoutPopup({
        postLogoutRedirectUri: CONFIG.msal.auth.postLogoutRedirectUri
      });
    }

    // =========================
    // SIMULADOR ‚Äî C√ÅLCULOS
    // =========================
    const fmtBRL = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });
    const fmtPct = new Intl.NumberFormat("pt-BR", { style: "percent", minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function parseBRLToNumber(s) {
      if (typeof s === "number") return s;
      if (!s) return NaN;
      s = String(s).replace(/\s|R\$\s?/g, "");
      if (s.includes(",") && s.includes(".")) s = s.replace(/\./g, "").replace(",", ".");
      else if (s.includes(",")) s = s.replace(",", ".");
      return Number(s);
    }

    function calcular() {
      const salario = parseBRLToNumber(salarioInput.value);
      const dias = Number(diasInput.value);

      if (!isFinite(salario) || salario <= 0) {
        alert("Informe um sal√°rio bruto v√°lido.");
        salarioInput.focus();
        return;
      }
      if (!Number.isInteger(dias) || dias < 1 || dias > 5) {
        alert("A quantidade de dias deve estar entre 1 e 5.");
        diasInput.focus();
        return;
      }

      const valorHora = salario / 220;
      const valorDia  = valorHora * 8.8;
      const descontoFuncionario = (valorDia * dias) / 2;
      const custoEmpresa = ((salario / 220) * 1.36 * 8.8 * 0.5) * dias;

      const percentualSalario = descontoFuncionario / salario;
      const salarioEstimado = salario - descontoFuncionario;

      outCustoEmpresa.textContent = fmtBRL.format(custoEmpresa);
      outDescontoFunc.textContent = fmtBRL.format(descontoFuncionario);
      outPercentual.textContent = fmtPct.format(percentualSalario);
      outSalarioEstimado.textContent = fmtBRL.format(salarioEstimado);

      resultadoBox.classList.remove("hidden");
    }

    function limpar() {
      salarioInput.value = "";
      diasInput.value = 1;
      [outCustoEmpresa, outDescontoFunc, outPercentual, outSalarioEstimado].forEach(el => el.textContent = "‚Äî");
      resultadoBox.classList.add("hidden");
    }

    btnCalcular.addEventListener("click", calcular);
    btnLimpar.addEventListener("click", limpar);
  </script>
</body>
</html>
