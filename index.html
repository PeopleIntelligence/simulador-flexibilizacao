<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Descontos de Flexibiliza√ß√£o</title>

  <!-- MSAL.js v2: Authorization Code + PKCE (recomendado para SPA) -->
  <script/alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js</script>

  <style>
    :root{
      --brand:#004578; --accent:#0067b8; --accent-hover:#005a9e; --danger:#d13438;
      --bg:#f7f7f7; --card:#ffffff; --muted:#666; --border:#eaeaea;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#111; }
    header, footer { background: var(--brand); color:#fff; padding: 16px 20px; }
    main { max-width: 960px; margin: 24px auto; background: var(--card);
           border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,.08); padding: 24px; }
    h1,h2{margin:0 0 12px 0}
    .muted { color: var(--muted); font-size: 14px; }
    .hidden { display:none !important; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .btn { border:0; background: var(--accent); color:#fff; padding:12px 16px; border-radius:6px; font-weight:600; cursor:pointer; }
    .btn:hover { background: var(--accent-hover); }
    .btn-danger{ background: var(--danger); }
    .pill { background:#ecf6ff; color:var(--brand); font-weight:600; padding:6px 10px; border-radius:999px; }
    .error { background:#fff5f5; border:1px solid #ffcccc; color:#9b1c1c; padding:12px; border-radius:6px; margin:12px 0; }
    .card { background:#fafafa; border:1px solid var(--border); border-radius:10px; padding:16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width:720px){ .grid{ grid-template-columns: 1fr; } }
    /* Campos do simulador */
    .simulador label{ display:block; font-weight:600; margin-bottom:6px; }
    .simulador input{ width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; }
    .result strong{ display:block; margin-bottom:8px; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div><strong>üè¢ Autentica√ß√£o Corporativa</strong></div>
      <div id="userBadge" class="hidden">
        <span class="pill" id="userEmail">usuario@empresa.com</span>
        <button id="btnLogout" class="btn btn-danger">Sair</button>
      </div>
    </div>
  </header>

  <main>
    <h1>üîê Simulador de Descontos de Flexibiliza√ß√£o</h1>
    <p class="muted">Acesso Restrito ‚Äî Gestores e L√≠deres (login com conta corporativa Microsoft).</p>

    <!-- Mensagens (erros/avisos) -->
    <div id="msg" class="error hidden"></div>

    <!-- ===== Tela de Login (mostra antes de autenticar) ===== -->
    <section id="loginView">
      <div class="card">
        <h2>üè¢ Autentica√ß√£o Corporativa</h2>
        <p>Use suas credenciais Microsoft da empresa para acessar o simulador.</p>
        <button id="btnLogin" class="btn">Entrar com Microsoft</button>
      </div>
    </section>

    <!-- ===== Tela do Usu√°rio Autenticado + Simulador ===== -->
    <section id="appView" class="hidden">
      <div class="card">
        <h2>##### Usu√°rio Autenticado</h2>
        <div class="muted" id="authUserHint">Voc√™ est√° autenticado como <strong id="authUserEmail">usuario@empresa.com</strong>.</div>
      </div>

      <h2>üìä Simulador</h2>
      <div class="card simulador">
        <p class="muted">
          ‚ö†Ô∏è Aten√ß√£o: Os valores calculados s√£o estimativas e t√™m apenas car√°ter orientativo.
          Os valores definitivos ser√£o informados na folha de pagamento. A empresa remunera 50% das horas n√£o trabalhadas.
          <br>üìã Jornada considerada: Esta simula√ß√£o considera uma jornada de trabalho de <strong>8,8 horas por dia</strong>.
        </p>

        <div class="grid">
          <div>
            <label for="salario">Sal√°rio bruto mensal (R$)</label>
            <input id="salario" type="number" step="0.01" placeholder="Ex.: 5000,00" />
          </div>
          <div>
            <label for="dias">Quantidade de dias de flexibiliza√ß√£o</label>
            <input id="dias" type="number" step="1" placeholder="Ex.: 3" />
          </div>
        </div>

        <div style="margin-top:16px">
          <button id="btnCalcular" class="btn">Calcular Simula√ß√£o</button>
        </div>
      </div>

      <h3>üìà Resultado da Simula√ß√£o</h3>
      <div class="grid result">
        <div class="card">
          <strong>Custo para empresa (com encargos)</strong>
          <div id="outCustoEmpresa">‚Äî</div>
        </div>
        <div class="card">
          <strong>Desconto do funcion√°rio</strong>
          <div id="outDescontoFunc">‚Äî</div>
        </div>
        <div class="card">
          <strong>Percentual do sal√°rio</strong>
          <div id="outPercSalario">‚Äî</div>
        </div>
        <div class="card">
          <strong>Sal√°rio estimado*</strong>
          <div id="outSalarioEstimado">‚Äî</div>
          <div class="muted" style="margin-top:8px">
            *Importante: O "Sal√°rio estimado" n√£o considera encargos, descontos de benef√≠cios, horas extras e outros fatores. Por isso √© apenas um valor estimado para orienta√ß√£o.
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>üìë M√©todo de c√°lculo</h3>
        <ul>
          <li>Valor hora = Sal√°rio bruto √∑ 220 horas</li>
          <li>Valor dia = Valor hora √ó 8,8 horas (jornada normal)</li>
          <li>Desconto funcion√°rio = (Valor dia √ó Dias flexibilizados) √∑ 2</li>
          <li>Custo empresa = ((Sal√°rio √∑ 220) √ó 1,36 √ó 8,8 √ó 0,5) √ó Dias flexibilizados</li>
        </ul>
      </div>
    </section>
  </main>

  <footer>
    <small>¬© People Intelligence ‚Äî uso interno. Acesso controlado via Microsoft Entra ID.</small>
  </footer>

  <script>
    // ==============================
    // MSAL v2 (Authorization Code + PKCE)
    // ==============================
    const msalConfig = {
      auth: {
        clientId: "0c2709b6-cbe4-4e55-9967-f9619abddc54",
        authority: "https://login.microsoftonline.com/812a6bd0-5829-4196-b2be-d0580b7bd0cb",
        redirectUri: "https://peopleintelligence.github.io/simulador-flexibilizacao/"
      },
      cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false },
      system: {
        // Em alguns ambientes (e.g., p√°ginas embed) o redirect dentro de iframe ajuda
        allowRedirectInIframe: true,
        loggerOptions: {
          loggerCallback: (level, message, containsPii) => { if (level <= msal.LogLevel.Warning) console.warn("[MSAL]", message); },
          piiLoggingEnabled: false,
          logLevel: msal.LogLevel.Warning
        }
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = { scopes: ["openid", "profile", "email"] };

    // ====== UI refs ======
    const els = {
      loginView: document.getElementById("loginView"),
      appView: document.getElementById("appView"),
      msg: document.getElementById("msg"),
      userBadge: document.getElementById("userBadge"),
      userEmail: document.getElementById("userEmail"),
      authUserEmail: document.getElementById("authUserEmail"),
      btnLogin: document.getElementById("btnLogin"),
      btnLogout: document.getElementById("btnLogout"),
      btnCalcular: document.getElementById("btnCalcular"),
      salario: document.getElementById("salario"),
      dias: document.getElementById("dias"),
      outCustoEmpresa: document.getElementById("outCustoEmpresa"),
      outDescontoFunc: document.getElementById("outDescontoFunc"),
      outPercSalario: document.getElementById("outPercSalario"),
      outSalarioEstimado: document.getElementById("outSalarioEstimado")
    };

    function showError(err) {
      console.error(err);
      let msg = (err && (err.errorMessage || err.message)) || String(err);

      // Mensagens amig√°veis para erros comuns
      const text = (s) => s ? s.toLowerCase() : "";
      const m = text(msg);
      if (m.includes("aadsts50105")) {
        msg = "Acesso n√£o autorizado: seu usu√°rio n√£o est√° atribu√≠do a este aplicativo. Solicite acesso √† TI (gestores/l√≠deres).";
      } else if (m.includes("no reply address provided") || m.includes("redirect_uri")) {
        msg = "Configura√ß√£o de Redirecionamento inv√°lida no Entra ID. Verifique a Redirect URI em Azure > App registrations > Authentication.";
      } else if (m.includes("aadsts700016")) {
        msg = "Aplicativo n√£o encontrado/Client ID incorreto. Verifique o Client ID e o Tenant ID.";
      }

      els.msg.textContent = msg;
      els.msg.classList.remove("hidden");
    }

    function setAuthenticatedUI(account) {
      els.msg.classList.add("hidden");
      els.loginView.classList.add("hidden");
      els.appView.classList.remove("hidden");
      els.userBadge.classList.remove("hidden");
      const who = account && (account.username || account.name || "Usu√°rio");
      els.userEmail.textContent = who;
      els.authUserEmail.textContent = who;
    }

    function setLoggedOutUI() {
      els.appView.classList.add("hidden");
      els.userBadge.classList.add("hidden");
      els.loginView.classList.remove("hidden");
    }

    async function startup() {
      try {
        // Trata retorno do redirect (login/logout)
        const response = await msalInstance.handleRedirectPromise();
        if (response && response.account) {
          msalInstance.setActiveAccount(response.account);
        }
        let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
        if (account) {
          setAuthenticatedUI(account);
        } else {
          setLoggedOutUI();
        }
      } catch (e) {
        showError(e);
        setLoggedOutUI();
      }
    }

    // Login
    els.btnLogin.addEventListener("click", () => {
      msalInstance.loginRedirect(loginRequest);
    });

    // Logout
    els.btnLogout.addEventListener("click", () => {
      msalInstance.logoutRedirect({ postLogoutRedirectUri: msalConfig.auth.redirectUri });
    });

    // ====== L√≥gica do simulador (com base no m√©todo compartilhado) ======
    els.btnCalcular.addEventListener("click", () => {
      const salario = parseFloat(String(els.salario.value).replace(",", ".")) || 0;
      const dias = parseInt(els.dias.value, 10) || 0;

      // M√©todo de c√°lculo conforme especificado no conte√∫do original
      // ‚Ä¢ Valor hora = Sal√°rio bruto √∑ 220 horas
      // ‚Ä¢ Valor dia = Valor hora √ó 8,8 horas (jornada normal)
      // ‚Ä¢ Desconto funcion√°rio = (Valor dia √ó Dias flexibilizados) √∑ 2
      // ‚Ä¢ Custo empresa = ((Sal√°rio √∑ 220) √ó 1,36 √ó 8,8 √ó 0,5) √ó Dias flexibilizados
      const valorHora = salario / 220;
      const valorDia = valorHora * 8.8;
      const descontoFuncionario = (valorDia * dias) / 2;
      const custoEmpresa = ((salario / 220) * 1.36 * 8.8 * 0.5) * dias;
      const salarioEstimado = Math.max(salario - descontoFuncionario, 0);
      const percSalario = salario ? (descontoFuncionario / salario) * 100 : 0;

      const brl = (v) => v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

      els.outCustoEmpresa.textContent = brl(custoEmpresa);
      els.outDescontoFunc.textContent = brl(descontoFuncionario);
      els.outPercSalario.textContent = percSalario.toFixed(2) + "%";
      els.outSalarioEstimado.textContent = brl(salarioEstimado);
    });

    startup();
  </script>
</body>
</html>
